# MyBlog Makefile

.PHONY: help dev build run clean test deps air-install lint lint-install format quality-check

# é»˜è®¤ç›®æ ‡
help:
	@echo "MyBlog é¡¹ç›®å‘½ä»¤:"
	@echo "  make dev        - å¯åŠ¨å¼€å‘ç¯å¢ƒ (çƒ­æ›´æ–°)"
	@echo "  make build      - ç¼–è¯‘é¡¹ç›®"
	@echo "  make run        - è¿è¡Œç¼–è¯‘åçš„ç¨‹åº"
	@echo "  make clean      - æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
	@echo "  make test       - è¿è¡Œæµ‹è¯•"
	@echo "  make deps       - å®‰è£…/æ›´æ–°ä¾èµ–"
	@echo "  make air-install- å®‰è£…Airçƒ­æ›´æ–°å·¥å…·"
	@echo "  make lint       - è¿è¡Œä»£ç æ£€æŸ¥ (golangci-lint)"
	@echo "  make lint-install- å®‰è£…golangci-lintå·¥å…·"
	@echo "  make format     - æ ¼å¼åŒ–ä»£ç  (gofmt + goimports)"
	@echo "  make quality-check- è¿è¡Œå®Œæ•´ä»£ç è´¨é‡æ£€æŸ¥"

# å¼€å‘ç¯å¢ƒ (çƒ­æ›´æ–°)
dev:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
	@if ! command -v air > /dev/null; then \
		echo "ğŸ“¦ æ­£åœ¨å®‰è£… Air..."; \
		go install github.com/cosmtrek/air@latest; \
	fi
	@mkdir -p tmp
	@air -c .air.toml

# ç¼–è¯‘é¡¹ç›®
build:
	@echo "ğŸ”¨ ç¼–è¯‘é¡¹ç›®..."
	@mkdir -p bin
	@go build -o bin/myblog ./cmd/myblog
	@echo "âœ… ç¼–è¯‘å®Œæˆ: bin/myblog"

# è¿è¡Œé¡¹ç›®
run: build
	@echo "ğŸš€ è¿è¡Œé¡¹ç›®..."
	@./bin/myblog

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
	@rm -rf tmp/ bin/ logs/
	@echo "âœ… æ¸…ç†å®Œæˆ"

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	@go test -v ./...

# å®‰è£…/æ›´æ–°ä¾èµ–
deps:
	@echo "ğŸ“¦ å®‰è£…/æ›´æ–°ä¾èµ–..."
	@go mod tidy
	@go mod download
	@echo "âœ… ä¾èµ–æ›´æ–°å®Œæˆ"

# å®‰è£…Airçƒ­æ›´æ–°å·¥å…·
air-install:
	@echo "ğŸ“¦ å®‰è£… Air çƒ­æ›´æ–°å·¥å…·..."
	@go install github.com/cosmtrek/air@latest
	@echo "âœ… Air å®‰è£…å®Œæˆ"

# å®‰è£…golangci-lintå·¥å…·
lint-install:
	@echo "ğŸ“¦ å®‰è£… golangci-lint å·¥å…·..."
	@if ! command -v golangci-lint > /dev/null; then \
		echo "æ­£åœ¨ä¸‹è½½å¹¶å®‰è£… golangci-lint..."; \
		curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2; \
	else \
		echo "golangci-lint å·²å®‰è£…"; \
	fi
	@echo "âœ… golangci-lint å®‰è£…å®Œæˆ"

# è¿è¡Œä»£ç æ£€æŸ¥ (golangci-lint)
lint:
	@echo "ğŸ” è¿è¡Œ golangci-lint ä»£ç æ£€æŸ¥..."
	@if ! command -v golangci-lint > /dev/null; then \
		echo "ğŸ“¦ golangci-lint æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."; \
		$(MAKE) lint-install; \
	fi
	@golangci-lint run
	@echo "âœ… ä»£ç æ£€æŸ¥å®Œæˆ"

# æ ¼å¼åŒ–ä»£ç  (gofmt + goimports)
format:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	@echo "è¿è¡Œ gofmt..."
	@go fmt ./...
	@echo "è¿è¡Œ goimports..."
	@if ! command -v goimports > /dev/null; then \
		echo "ğŸ“¦ æ­£åœ¨å®‰è£… goimports..."; \
		go install golang.org/x/tools/cmd/goimports@latest; \
	fi
	@goimports -w .
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# ä½¿ç”¨ Node.js è„šæœ¬æ ¼å¼åŒ–ä»£ç  (è·¨å¹³å°)
format-js:
	@node scripts/format-code.js

# æ ¼å¼åŒ–ä»£ç  (ä¿æŒå‘åå…¼å®¹)
fmt: format

# ä»£ç æ£€æŸ¥
vet:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	@go vet ./...
	@echo "âœ… ä»£ç æ£€æŸ¥å®Œæˆ"

# è¿è¡Œå®Œæ•´ä»£ç è´¨é‡æ£€æŸ¥
quality-check: format lint vet test
	@echo "âœ… å®Œæ•´ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"
	@echo "ğŸ“ æç¤º: åœ¨ monorepo æ ¹ç›®å½•è¿è¡Œ 'npm run lint:go' å¯ä»¥åœ¨ CI/CD æµç¨‹ä¸­æ‰§è¡Œæ­¤æ£€æŸ¥"

# å®Œæ•´æ£€æŸ¥ (æ ¼å¼åŒ– + æ£€æŸ¥ + æµ‹è¯•) - ä¿æŒå‘åå…¼å®¹
check: quality-check